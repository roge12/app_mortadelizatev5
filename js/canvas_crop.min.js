$(document).ready(function() {
	// init();
	$('.color').click(function(){
		if($(this).hasClass("active")){
			return false;
		} else {
			$('.filter_button').removeClass('active');
			$(this).addClass('active');
			removeFilters();
		}
	});
	$('.grayscale').click(function(){
		if($(this).hasClass("active")){
			return false;
		} else {
			$('.filter_button').removeClass('active');
			$(this).addClass('active');
			filterPhoto([Grayscale]);
		}
	});
	$('.sepia').click(function(){
		if($(this).hasClass("active")){
			return false;
		} else {
			$('.filter_button').removeClass('active');
			$(this).addClass('active');
			filterPhoto([Sepia]);			
		}
	});
});
var stage, container, canvas, frame, imgPath, userPhoto, image;
var factor;
var update = true;
var Grayscale = new createjs.ColorMatrixFilter([
        0.30,0.30,0.30,0,0, // red component
        0.30,0.30,0.30,0,0, // green component
        0.30,0.30,0.30,0,0, // blue component
        0,0,0,1,0  // alpha
]);
var Sepia = new createjs.ColorMatrixFilter([
    0.39, 0.77, 0.19, 0, 0, // red component
    0.35, 0.68, 0.17, 0, 0, // green component
    0.27, 0.53, 0.13, 0, 0, // blue component
    0, 0, 0, 1, 0  // alpha
]);
function init (param_urlfoto){

	console.log("en init: "+param_urlfoto);

	canvas = document.getElementById("results-file");
	stage = new createjs.Stage(canvas);
	createjs.Touch.enable(stage);
	stage.enableMouseOver(10);
	stage.mouseMoveOutside = true;
	//imgPath = $('#results-file').data('id');
	imgPath = param_urlfoto;
	// imgPath = "/produccion/images/marco-foto.png";
	// imgPath = "/produccion/images/marco-foto.png";
	loadFrame(param_urlfoto);
}
function loadFrame(param_urlfoto2){
	var img = new Image();
	// img.src = "/assets/photo-frame.png";
	img.src = $('#results-file').data('id');
	img.src = param_urlfoto2;
	img.onload = handleFrameLoad;

	console.log("en loadFrame: "+img.onload);
}
function handleFrameLoad(event) {
	frame = new createjs.Bitmap(event.target);

	console.log("en handleFrameLoad: "+event.target);
	
	loadImage();
}
function loadImage(){
	image = new Image();
    image.src = imgPath; 
    image.onload = function (event) {
    	
    	console.log("en loadImage: "+image.src);

        userPhoto = new createjs.Bitmap(event.target);
        var initialWidth = userPhoto.width;
        var initialHeight = userPhoto.height;
        container = new createjs.Container(); 
        container.width = 498;
        container.height = 353;
        container.x = 0;
        container.y = 0; 		 
		container.addChild(userPhoto);	
		if (((498*userPhoto.getBounds().height)/userPhoto.getBounds().width) >= 353){

			console.log("aqui1");
			initialTransformedWidth = 498;
			initialTransformedHeight = (498*userPhoto.getBounds().height)/userPhoto.getBounds().width;
			userPhoto.setWidth(498);
        	userPhoto.setHeight(initialTransformedHeight);
    	} else {
    		console.log("aqui2");
    		initialTransformedWidth = userPhoto.getBounds().width;
    		initialTransformedHeight = userPhoto.getBounds().height;
    	}
    	initialScale = initialTransformedWidth/userPhoto.getBounds().width;
    	factor = initialScale;
		var mascara = new createjs.Shape();
		mascara.graphics.beginFill("red").rect(0, 0, 498, 353);
		userPhoto.mask = mascara;
		// container.addChild(frame);
		frame.mouseEnabled = false;
		frame.x=0;
		frame.y=0;
        stage.addChild(container);

		// $('#btn-zoom1, #btn-zoom0').on('click',zoom(x+1));
		// $('#btn-izq, #btn-dcha').on('click',moverVertical);
		// $('#btn-arriba, #btn-abajo').on('click',moverVertical);

		// $('#btn-zoom1').on('click',Hacerzoom());

        container.on("mousedown", function(evt) {
			userPhoto.offset = {x:userPhoto.x-evt.stageX, y:userPhoto.y-evt.stageY};
			console.log("x")
		});
		container.on("pressmove", function(evt) {
			var moveX = evt.stageX+ userPhoto.offset.x
			var moveY = evt.stageY+ userPhoto.offset.y;
			if((moveX + userPhoto.getTransformedBounds().width >= 1) && (moveX <= 0)){

				console.log("moviendo x");
				userPhoto.x = moveX;
			}
			if((moveY + userPhoto.getTransformedBounds().height >= 1) && (moveY <= 0)){
				userPhoto.y = moveY;
			}
			update = true;
		});
		setSlider();
        update = true;
    }
    createjs.Ticker.addEventListener("tick", tick);
}
function filterPhoto(color){
	userPhoto = userPhoto.clone();
    userPhoto.filters = color; 
    userPhoto.cache(0,0,image.width,image.height);
    container.addChild(userPhoto);
    container.addChild(frame);
    frame.mouseEnabled = false;
    update = true;
}
function removeFilters(){
	userPhoto = userPhoto.clone();
    userPhoto.cache(0,0,image.width,image.height);
    container.addChild(userPhoto);
    container.addChild(frame);
    frame.mouseEnabled = false;
    update = true;
}
function zoom(factor){	
	//scaleComponent(userPhoto, container);
	userPhoto.scaleX = initialScale*factor;
	userPhoto.scaleY = initialScale*factor;
	if (userPhoto.getTransformedBounds().x + userPhoto.getTransformedBounds().width < 498){
		userPhoto.x = 498 - (userPhoto.getTransformedBounds().width);
	}
	if (userPhoto.getTransformedBounds().y + userPhoto.getTransformedBounds().height < 353 ){
		userPhoto.y = 353 - userPhoto.getTransformedBounds().height;
	}
	update = true;
}

function Menoszoom(){	
	//scaleComponent(userPhoto, container);

	factor -= 0.1;

	console.log("haciendo zoom: "+factor);

	userPhoto.scaleX = factor;
	userPhoto.scaleY = factor;

	// scaleComponent(userPhoto, container);
	if (userPhoto.getTransformedBounds().x + userPhoto.getTransformedBounds().width < 498){
		userPhoto.x = 498 - (userPhoto.getTransformedBounds().width);
	}
	if (userPhoto.getTransformedBounds().y + userPhoto.getTransformedBounds().height < 353 ){
		userPhoto.y = 353 - userPhoto.getTransformedBounds().height;
	}	

	update = true;
}

function Maszoom(){	
	// scaleComponent(userPhoto, container);

	factor += 0.1;

	console.log("haciendo zoom: "+factor);

	userPhoto.scaleX = factor;
	userPhoto.scaleY = factor;

	// scaleComponent(userPhoto, container);
	if (userPhoto.getTransformedBounds().x + userPhoto.getTransformedBounds().width < 498){
		userPhoto.x = 498 - (userPhoto.getTransformedBounds().width);
	}
	if (userPhoto.getTransformedBounds().y + userPhoto.getTransformedBounds().height < 353 ){
		userPhoto.y = 353 - userPhoto.getTransformedBounds().height;
	}	

	update = true;
}

function cropImage(){
	$('#btn-continuar-snapshot').html('<p>Guardando, por favor, espera...</p>');
	// var userPhotoId = $('#crop_page').data('id');
	container.cache(0,0,498,353);
	var data = container.getCacheDataURL();	
	$.ajax({
        type: "POST",
        url: "upload-temp.php",
        data: { 
            imgBase64: data
        }
    }).done(function(respond) {
        console.log('saved: '+respond);
        var urlFotoTemp = urlHost+respond;
        $('#my_camera').data('urltemp',urlFotoTemp);
        mostrarEleccionPersonajes();
    });
}

function tick(event) {
		if (update) {
			update = false;
			stage.update(event);
		}
}
createjs.Bitmap.prototype.setWidth = function(w)
{       
    if (this.image.width == 0) return;
    
    this.scaleX = w / this.image.width;
}
    
createjs.Bitmap.prototype.setHeight = function(h)
{
    if (this.image.height == 0) return;

    this.scaleY = h / this.image.height;
}
function setSlider(){
	// $('#crop_photo').click(function(){
	// 	cropImage();
	// });
	// $('#btn-dcha').click(function(){
	// 	cropImage();
	// });

	$('#btn-continuar-snapshot').click(function(){
		cropImage();
	});

	$('#btn-continuar-snapshot').animate({opacity: 1});	


	new Dragdealer('my-slider',
	{
		snap: false,
		animationCallback: function(x, y)
		{
			zoom(x+1);
		}
	});
}
function scaleComponent(node, holder) {
	node.regX = node.getTransformedBounds().width/2;
	node.regY = node.getTransformedBounds().height/2;
	node.x = 498-node.regX;
	node.y = 353-node.regY
 }