
var pos = 0;
var anchoContenedor = $('.contenedor-listado').width();
var cantidadFotos = $('.listado-personajes li').size();
var limiteIzqdo = -267*(cantidadFotos-1);
var limiteDcho = 0;
var tamVentana = $(window).width();

var cantidadFrases = $('.listado-frases li').size();
var limiteIzqdoFrases = -267*(cantidadFrases-1);
var limiteDchoFrases = 0;


/*Variables obtener snapshot de la camara*/

var data_uri;
var oContexto;
var oURL, canvasfileURL;
var imageLoader;
var canvasfile;
var ctx;
// var flagcolocar1 = false;
// var flagcolocar2 = false;
// var flagcolocar3 = false;
// var flagcolocar4 = false;
var idOpcionEncuadre;
var img_obj_big1;
var img_obj_big2;
var img_obj_big3;

var objPers1 = $('.listado-objetos #objeto1').data('objetobig');
var objPers2 = $('.listado-objetos #objeto2').data('objetobig');
var objPers3 = $('.listado-objetos #objeto3').data('objetobig');

var cont_personajes =1;
var idObjPersonaje;

var objetoUno = 0;
var objetoDos = 0;
var objetoTres = 0;
var idObjPersonaje_anteriorUno;
var idObjPersonaje_anteriorDos;
var idObjPersonaje_anteriorTres;
var urlHost;
var urlHostName;

var widthCamara = 498;
var heightCamara = 0;

var widthFoto = 498;
var heightFoto = 353;
var vData;
var vDataFinal;

var imgHover;
var srcOri;

var objBig1;
var objBig2;
var objBig3;

var tamañoPersonaje = 'Big';



var inc_zoom= 0.1;
var zoomefec = 1;
var inc_vertical= 5;
var verticalefec = 0;
var inc_horizontal= 5;
var horizontalefec = 0;
var inc_rotate= 90;
var rotateefec = 0;
var versionDevices;





$('#btn-terminar').on('click', volverInicio);

$('#btn-cerrar-mail').on('click', cierraFormMail);

/*Acciones para los snapshot de la camara y upload de fotografia*/

// $('#btn-selec-sube, #btn-selec-hazte').on('click',mostrarEleccionFotografia);


/*Acciones para los objetos de cada personaje para mortadelizarse*/
$('.listado-objetos #objeto1 a').on('click', colocarObjeto1);
$('.listado-objetos #objeto2 a').on('click', colocarObjeto2);
$('.listado-objetos #objeto3 a').on('click', colocarObjeto3);
// $('.objetos #objeto4').on('click', colocarObjeto4);




	// $('.intro').hide();
	// $('.secciones').show();
	// $('.elige-personaje').hide();
	// $('.elige-frase').show();


$('#esquinas, #encuadre').css('display','none');


$('#btn-empezar').on('click', mostrarInstrucciones);
$('#btn-entendido').on('click', mostrarFotografiado);


$('#btn-selec-sube').on('click',mostrarEncuadrar);
$('#btn-selec-hazte').on('click',mostrarEncuadrar);



$('#btn-snapshot').on('click',take_snapshot);
$('#btn-repetir-snapshot').on('click',repetirEleccionFotografia);



// $('#btn-continuar-snapshot').on('click',mostrarEleccionPersonajes);

$('#btn-continuar-personajes').on('click',mostrarEligeFrase);



$('#btn-confirmar').on('click', mostrarCompartirRedes);

$('#enviar-mail').on('click', mostrarFormularioMail);


// $('#btn-izq, #btn-dcha').on('click',moverVertical);
// $('#btn-arriba, #btn-abajo').on('click',moverVertical);
// $('#btn-zoom1, #btn-zoom0').on('click',moverVertical);
// $('#btn-rota').on('click',moverVertical);

$('#btn-atras-encuadrate').on('click',volverAtras);
$('#btn-atras-personajes').on('click',volverAtras);

$('#btn-zoom0').on('click',Menoszoom);
$('#btn-zoom1').on('click',Maszoom);


/*Mover la foto de lugar*/



// function moverVertical (e) 
// {
	
// 	var idmoverFoto = $(this).attr("id");
// 	console.log("idmoverFoto: "+idmoverFoto);

// 	if(idmoverFoto == 'btn-abajo'){	verticalefec += inc_vertical;}
// 	if(idmoverFoto == 'btn-arriba'){ verticalefec -= inc_vertical;}
// 	if(idmoverFoto == 'btn-dcha'){ horizontalefec += inc_horizontal;}
// 	if(idmoverFoto == 'btn-izq'){ horizontalefec -= inc_horizontal;}
// 	if(idmoverFoto == 'btn-zoom1'){ zoomefec += inc_zoom;}
// 	if(idmoverFoto == 'btn-zoom0'){ zoomefec -= inc_zoom;}


// 	$("#results-file").css({
// 	 transform: 'translateY('+verticalefec+'px)' + 'translateX('+horizontalefec+'px)' + 'scale(' + zoomefec + ')',
// 	 MozTransform: 'translateY('+verticalefec+'px)' + 'translateX('+horizontalefec+'px)' + 'scale(' + zoomefec + ')',
// 	 WebkitTransform: 'translateY('+verticalefec+'px)' + 'translateX('+horizontalefec+'px)' + 'scale(' + zoomefec + ')',
// 	 msTransform: 'translateY('+verticalefec+'px)' + 'translateX('+horizontalefec+'px)' + 'scale(' + zoomefec + ')'
// 	});	

// 	e.preventDefault();
// }



// function transmitirPosicionamiento (param_id_rotado, param_rotacion) 
// {
// 	var zoomFoto = zoomefec;
// 	var verticalFoto = verticalefec;
// 	var horizontalFoto = horizontalefec;
// 	var rotacionFoto = rotateefec;

// 	if(param_rotacion == -1)
// 		rotacionFoto = rotateefec;

// 	else
// 		rotacionFoto = param_rotacion;


// 	console.log("transmitiendo posicionamiento: "+zoomFoto+"|"+verticalFoto+"|"+horizontalFoto +"|"+rotacionFoto);



// 	$(param_id_rotado).css({
// 	 transform: 'translateY('+verticalefec+'px)' + 'translateX('+horizontalefec+'px)' + 'scale(' + zoomefec + ')',
// 	 MozTransform: 'translateY('+verticalefec+'px)' + 'translateX('+horizontalefec+'px)' + 'scale(' + zoomefec + ')',
// 	 WebkitTransform: 'translateY('+verticalefec+'px)' + 'translateX('+horizontalefec+'px)' + 'scale(' + zoomefec + ')',
// 	 msTransform: 'translateY('+verticalefec+'px)' + 'translateX('+horizontalefec+'px)' + 'scale(' + zoomefec + ')'
// 	});

// }



/*Detectar Mobile*/


function volverInicio (e) 
{
	e.preventDefault();
	location.reload();
}

// $(window).load(function() {
//      $("#myCarousel-gal").height($("#myCarousel-gal .content").height());
//  });


// calling jPreLoader
$(document).ready( function() {

		urlHost = document.URL;
		urlHostName = window.location.hostname;
		console.log("hostName: "+urlHost+urlHostName);

		// RedirectSmartphone("http://www.mortadeloyfilemon3D.com");

		versionDevices = urlHost + "index-devices.html";
		RedirectSmartphone(versionDevices);

		$('#btn-continuar-snapshot').off().fadeTo( "slow" , 0.3);

        $('body').jpreLoader({
            splashID: "#jSplash",
            showPercentage: true,
            loaderVPos: '70%',
            autoClose: true,
            closeBtnText: "Comenzar!",
            debugMode: false,
            splashFunction: function() {
                $('#jSplash').hide().fadeIn(800);
            }
        }, function () {

        		console.log("entrando");

			    var hrefLineIntro = $('.descargas #btn-1').attr('href');
				var hrefLineSecciones = $('.descargas-secciones #btn-1').attr('href');

				$('#btn-continuar-snapshot').unbind('click', false);

			    // cargarImgObjetosMobile ();

				if(Utils.browser.searchMobile())
				{
					console.log("Es Mobile");

					widthCamara = 320;
					heightCamara = 0;

					widthFoto = 320;
					heightFoto = 227;


					$('.listado-opciones #opcion-camara').hide();
					$('.listado-opciones li').css('width', '100%');
					// $('.descargas #btn-1').attr('disabled', false);
					// $('.descargas-secciones #btn-1').attr('disabled', false);

					$('.descargas .btn-1').unbind('click', false);
					$('.descargas-secciones .btn-1').unbind('click', false);				

				}
				else
				{
					console.log("No es Mobile");

					$('.listado-opciones #opcion-camara').show();


					// $('.descargas #btn-1').attr('disabled', true);
					// $('.descargas-secciones #btn-1').attr('disabled', true);
					$('.descargas .btn-1').bind('click', false);
					$('.descargas-secciones .btn-1').bind('click', false);

					if(tam_ventana< 480)
					{
						widthCamara = 320;
						heightCamara = 0;

						widthFoto = 320;
						heightFoto = 227;

					}	

				}        		
              });

    });



var interuptor_camara = false;
var tam_ventana = $(window).innerWidth();
 console.log("tamaño ventana: "+tam_ventana);

$( window, document ).resize(function() {

	tam_ventana = $(window).innerWidth();

	console.log("tam ventana: "+ tam_ventana);

	if(tam_ventana< 768)
	{
		console.log("Es Mobile");
		$('.blanco').show();
		// RedirectSmartphone("http://www.mortadeloyfilemon3D.com");
		RedirectSmartphone(versionDevices);

		widthCamara = 320;
		heightCamara = 0;

		widthFoto = 320;
		heightFoto = 227;

		$('#results-file').attr('width', widthFoto);
		$('#results-file').attr('height', heightFoto);

				Webcam.set({
		    width: 320,
		    height: 0
		});

		// cargarImgObjetosMobile();
			
	
	}
	else
	{
		console.log("No es Mobile");
		$('.blanco').hide();
		RedirectSmartphone(urlHost);
	}

});


function cierraFormMail (e) 
{
	
	$('#form-mail').hide();
	$('#confirmar-enviar').show();

	e.preventDefault();

}

function cargarImgObjetosMobile () 
{



	if(Utils.browser.searchMobile() || tam_ventana< 480)
	{
		var pBig=1;

		while(pBig<=6)
		{
			objPers1 = $('.listado-personajes li').eq(pBig - 1).data('objsmall1');
			objPers2 = $('.listado-personajes li').eq(pBig - 1).data('objsmall2');
			objPers3 = $('.listado-personajes li').eq(pBig - 1).data('objsmall3');
			// colocarObjeto1();
			pBig++;
		}		

	}
	
	else
	{
		var pSmall=1;

		while(pSmall<=6)
		{		
			objPers1 = $('.listado-personajes li').eq(pSmall - 1).data('obj1');
			objPers2 = $('.listado-personajes li').eq(pSmall - 1).data('obj2');
			objPers3 = $('.listado-personajes li').eq(pSmall - 1).data('obj3');
			// colocarObjeto1();
			pSmall++;
		}
	}

	console.log("objPers1: "+ objPers1);
	console.log("objPers2: "+ objPers2);
	console.log("objPers3: "+ objPers3);



}


function volverAtras (e) 
{
	var idAtras = $(this).attr("id");
	console.log("ID pantalla anterior: "+idAtras);

	location.reload();

	// if(idAtras == 'btn-atras-encuadrate')
	// {	
		
	// 	// Webcam.reset();
	// 	$('.encuadrate').hide();
	// 	// mostrarFotografiado();
	// 	$('#btn-entendido').trigger('click');

	// 	document.getElementById('.camara').innerHTML = 
 //          '<canvas id="results-file"></canvas>';
	// 	// canvas.width = widthCamara;
	// 	// canvas.height = heightCamara;
		

	// }

	// if(idAtras == 'btn-atras-personajes')
	// {
	// 	$('.encuadrate').hide();
	// 	// mostrarEncuadrar();
		
	// 	if(idOpcionEncuadre=='btn-selec-sube')
	// 		$('#btn-selec-sube').trigger('click');
		
	// 	if(idOpcionEncuadre=='btn-selec-hazte')
	// 		$('#btn-selec-hazte').trigger('click');		
	// }


	e.preventDefault();
}


function mostrarInstrucciones (e) 
{
	
	console.log("Mostrando siguiente pantalla: ");

	$('.intro').hide();
	$('.secciones').show();

	$('.contenedor-secciones').addClass('pc-bacterio');
	$('.instrucciones').show();

	e.preventDefault();
	
}


function mostrarFotografiado (e) 
{
	
	console.log("Mostrando Fotografiado ");

	// var imageUrl ="images/tronchamulas.png";
	$('.instrucciones').hide();
	$('.contenedor-secciones').removeClass('pc-bacterio');
	$('.contenedor-secciones').addClass('tronchamulas');
	$('.fotografiado').show();

	

	e.preventDefault();
}


function mostrarEncuadrar (e) 
{
	idOpcionEncuadre = $(this).attr("id");

	console.log("Mostrando Encuadrate: id="+ idOpcionEncuadre);

	$('.fotografiado').hide();
	$('.contenedor-secciones').removeClass('pc-bacterio');
	$('.contenedor-secciones').removeClass('tronchamulas');
	$('.encuadrate').show();

	e.preventDefault();

	mostrarEleccionFotografia(idOpcionEncuadre);
}


function mostrarEleccionPersonajes (e) 
{

	console.log("Eleccion de personajes");


	console.log("WEBCAM???" +Webcam.loaded);

	if(idOpcionEncuadre =="btn-selec-sube")
	{
		console.log("pasando foto a Eleccion de personajes");
		take_snapshotFile();

		$('.encuadrate').hide();
		$('.elige-personaje').show();
		// e.preventDefault();		
	}
	else
	{
		e.preventDefault();

		if (!Webcam.loaded) return Webcam.dispatch('error', "ACTIVA LA CAMARA");

		else
		{
			$('.encuadrate').hide();
			$('.elige-personaje').show();
			e.preventDefault();	
		}

	}	


}


function mostrarEligeFrase (e) 
{
	
	screenshot();

	if(Utils.isIDevice)
	{	
		DoRotateFin(0);
	}

	e.preventDefault();
}


function mostrarCompartirRedes (e) 
{
	console.log("MostrarRedes");

	$('.titulo-envio p').html('Descárga la foto, envíala por mail o <span> compártela con tus amigos en tus redes sociales.</span>');
	$('.titulo-envio h1').text('Compártela.');

	UploadFoto();
	
	$('#btn-confirmar').hide();
	$('#confirmar-enviar').show();
	$('#btn-terminar').show();
}



/*Slider de Personajes*/

$('.listado-personajes').css('width', (cantidadFotos*100)+"%");
$('.listado-frases').css('width', (cantidadFrases*267)+"px");
// $('.listado li').css('width', (100/cantidadFotos)+"%");

$('.arrow-r').on('touchstart click',pasarFotoNext);
$('.arrow-l').on('touchstart click',pasarFotoPrev);

$('.arrow-frases-r').on('touchstart click',pasarFrasePrev);
$('.arrow-frases-l').on('touchstart click',pasarFraseNext);

function pasarFotoNext(e)
{
	e.stopPropagation(); 
	e.preventDefault();
	// alert("pasa foto");
	// $('.arrow-l').removeClass('inhabilita');
	if(cont_personajes>1 && cont_personajes<6)
		cont_personajes+=1;

	if(cont_personajes==1)
		cont_personajes+=1;

	var cuantos = $('.listado-personajes li').size();


	console.log("en next: "+cont_personajes+"..."+cuantos);

	console.log("limiteIzqdo: "+ limiteIzqdo);

	if(pos>limiteIzqdo)
	{
		pos -= 267;
		$('.listado-personajes').stop(true).animate({left: pos+"px"});

		mostrarObjetosPersonajes(cont_personajes);
	}
	else
	{
		console.log("llegado al final: "+ pos);
	}
	
	return false;
}

function pasarFotoPrev(e) 
{	
	e.stopPropagation();
	e.preventDefault();

	if(cont_personajes>1 && cont_personajes<6)
		cont_personajes-=1;

	if(cont_personajes==6)
		cont_personajes-=1;


	var cuantos = $('.listado-personajes li').size();


	console.log("en next: "+cont_personajes+"..."+cuantos);

	if(pos < limiteDcho)
	{
		pos += 267;
		$('.listado-personajes').stop(true).animate({left: pos+"px"});

		mostrarObjetosPersonajes(cont_personajes);
	}
	else
	{
		console.log("llegado al final: "+ pos);
	}

	

	return false;
}

function mostrarObjetosPersonajes (param_cont_personaje) 
{
	console.log("mostrando: "+param_cont_personaje);

	var contador_pers = param_cont_personaje;

	switch(true)
	{

		case (contador_pers <= 6 ):

			console.log("En case :"+ contador_pers);

			$('.listado-objetos li').removeClass('objs-1');
			$('.listado-objetos li').removeClass('objs-2');
			$('.listado-objetos li').removeClass('objs-3');
			$('.listado-objetos li').removeClass('objs-4');
			$('.listado-objetos li').removeClass('objs-5');
			$('.listado-objetos li').removeClass('objs-6');

			$('.listado-objetos li').addClass('objs-'+contador_pers);

			// $('.foto').removeClass('big1 big2 big3 big4 big5 big6');
			// $('.foto').addClass('big'+contador_pers);

			if(Utils.browser.searchMobile() || tam_ventana< 480)
			{
				objPers1 = $('.listado-personajes li').eq(contador_pers - 1).data('objsmall1');
				objPers2 = $('.listado-personajes li').eq(contador_pers - 1).data('objsmall2');
				objPers3 = $('.listado-personajes li').eq(contador_pers - 1).data('objsmall3');
				// colocarObjeto1 ();				

			}
			else
			{	
				objPers1 = $('.listado-personajes li').eq(contador_pers - 1).data('obj1');
				objPers2 = $('.listado-personajes li').eq(contador_pers - 1).data('obj2');
				objPers3 = $('.listado-personajes li').eq(contador_pers - 1).data('obj3');
			}

			console.log("objPers1: "+ objPers1);
			console.log("objPers2: "+ objPers2);
			console.log("objPers3: "+ objPers3);

			break;


		case (contador_pers > 6):
			console.log("Fuera de rango: ");

			break;


		default:
			break;
	}
}

function pasarFrasePrev(e)
{
	e.stopPropagation(); 
	e.preventDefault();
	// alert("pasa foto");
	// $('.arrow-l').removeClass('inhabilita');

	console.log("limiteIzqdoFrases: "+ limiteIzqdoFrases);

	if(pos>limiteIzqdoFrases)
	{
		pos -= 267;
		$('.listado-frases').stop(true).animate({left: pos+"px"});
	}
	else
	{
		console.log("llegado al final: "+ pos);
		// pos=-267;
		// $('.listado-personajes').css({left: limiteDcho+"px"});
		// $('.arrow-r').addClass('inhabilita');
		// document.getElementById("arrow-r").disabled = true;
	}

	
	
	return false;
}

function pasarFraseNext(e) 
{	
	e.stopPropagation();
	e.preventDefault();

	console.log("en next Frases: ");

	if(pos < limiteDchoFrases)
	{
		pos += 267;
		$('.listado-frases').stop(true).animate({left: pos+"px"});
	}
	else
	{
		console.log("llegado al final: "+ pos);
	}

	return false;
}

/********************************************************************/
/*			FUNCIONES PARA SNAPSHOT y UPLOAD DE LA CAMARA			*/
/********************************************************************/



function repetirEleccionFotografia (e) 
{

	console.log("repetir eleccion foto: "+idOpcionEncuadre);

	$('#btn-repetir-snapshot').hide();
	$('#btn-snapshot').show();

	e.preventDefault();

	mostrarEleccionFotografia (idOpcionEncuadre);
}

function mostrarEleccionFotografia (param_id) 
{
	var id_mostrar = param_id
	
	console.log("id_mostrar: "+id_mostrar);

	if(Utils.browser.searchMobile() )
	{
		console.log("Es Mobile");

		widthCamara = 320;
		heightCamara = 0;

		widthFoto = 320;
		heightFoto = 227;

		$('#opcion-camara').hide();
	}
	else
	{
		console.log("No es Mobile");

		if(tam_ventana< 480)
		{
			widthCamara = 320;
			heightCamara = 0;

			widthFoto = 320;
			heightFoto = 227;
		}	

	}

	// e.preventDefault();

	// $('.inicio').hide();
	// $('.upload-image').hide();

	//#btn-selec-sube, #btn-selec-hazte

	if(id_mostrar =="btn-selec-hazte")
	{
		//$('.upload-image').show();

		// Configure a few settings and attach camera
		$('.titulo-encuadrate p').text('Encuádrate en el marco, sonríe y click.');
		$('.titulo-encuadra').text('pa-ta-ta');

		$('#imagen').hide();

			// Webcam.reset();

			Webcam.set({
				width: widthCamara,
				height: heightCamara,
				image_format: 'jpeg',
				jpeg_quality: 90
			});
			Webcam.attach( '#my_camera');
			                                    
	}
	else
	{


		$('.titulo-encuadrate p').text('Recuerda que foto tiene que encajar en la guía.');
		$('.titulo-encuadra').text('Sube la foto');

		$('#imagen').show();

		$('#results-file').show();

		$('#btn-repetir-snapshot').hide();
		$('#btn-snapshot').hide();
		$('#btn-subir-snapshot').show();	
		
		btnSube = document.getElementById('input-subir-snapshot');
		btnSube.addEventListener('change', handleImage, false);
		// btnSube.addEventListener('change', init, false);		
		canvasfile = document.getElementById('results-file');
		ctx = canvasfile.getContext('2d');
		canvasfileURL = canvasfile.toDataURL();


		var html = $('<div class="esquinas-camara"><div class="encuadre"></div></div>');
		$('#my_camera').append(html);		

		// document.getElementById('results-file').innerHTML = 
		// 			'<h2>Here is your image:</h2>' + 
		// 			'<img src="'+canvasfileURL+'"/>' +
		// 			'<input id="btnsave" type=button value="screenSHot" onClick="screenshot()">';		
	
	}

}


function handleImage(e)
{
	var espequena=false;
    console.log("en handleImage");

 //    $('#btn-continuar-snapshot').on('click',mostrarEleccionPersonajes);
	// $('#btn-continuar-snapshot').animate({opacity: 1});	

    var reader = new FileReader();

	if (Modernizr.filereader)
	{  
           var fileName = $(this).val();
           var sizeInMB = (this.files[0].size / (1024*1024)).toFixed(2);
           //$(".file_reference").html(fileName.replace(/C:\\fakepath\\/i, ''));
           var extension = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();

           console.log("datos: "+fileName+sizeInMB+extension);

           if (extension != "jpg" && extension != "png" && extension != "jpeg"){
               // $('.new_user_photo').prepend("<div id='error_explanation'> <p>El archivo no es válido</p></div>");
               alert("El archivo no es válido. Sube un jpg, png o jpeg)");
               fileErrors = true;
               return false;
           } else {
               fileErrors = false;
           }
    }
       
    reader.onload = function(event){

    	console.log("reader.result: "+reader.result);
    	$('#results-file').data('id',reader.result);

    	init(reader.result);

   //      var img = new Image();
   //      // img.src = reader.result;


   //      img.onload = function(){
   //          var fotowidth = img.width;
   //          var fotoheight = img.height;

   //          console.log(fotowidth +"|" +fotoheight);



   //          var tamañoDispositivo = $(document).outerWidth();
   //          // alert("width: "+tamañoDispositivo + tam_ventana);

			// if(Utils.browser.searchMobile() && tamañoDispositivo< 480 )
			// {
			// 	// alert("Es Mobile en Handle");

			// 	widthCamara = 320;
			// 	heightCamara = 0;
			// 	widthFoto = 320;
			// 	heightFoto = 227;

			// }
			// else
			// {
			// 	widthCamara = 498;
			// 	heightCamara = 0;

			// 	// if(fotowidth >= 498 && fotoheight >= 353)
			// 	// {
			// 	// 	widthFoto = 498;
			// 	// 	heightFoto = 353;
			// 	// }
			// 	// else
			// 	// {	
			// 	// 	widthFoto = img.width;
			// 	// 	heightFoto = img.height;
			// 	// }

			// 	widthFoto = img.width;
			// 	heightFoto = img.height;			

			// }

			// if( fotowidth < 1 && fotoheight < 1)
			// {
			// 	alert("Tu foto es demasiado pequeña, elige otra para poder verte mortadelizado (mínimo: 498x353)");
			// }

			// else
			// {	

	  //           // alert("widthFoto: "+widthFoto+"-"+"heightFoto: "+heightFoto);
	  //           canvasfile.width = widthFoto;
	  //           canvasfile.height = heightFoto;
			// 	widthFoto = Math.max(1, Math.floor(widthFoto));
			// 	heightFoto = Math.max(1, Math.floor(heightFoto));       
	  //           ctx.drawImage(img,0,0,widthFoto,heightFoto);
	  //       }
   //      }		


        // 	img.src = event.target.result;
        // 	canvasfileURL = img.src;
        // console.log("src: "+img.src);
    }

		     
    reader.readAsDataURL(e.target.files[0]);

	// if(Utils.browser.searchMobile())
	// {	
	// 	console.log("rotando foto");
	// 	DoRotate(90);
	// }

}



function take_snapshotFile() {

		// cropImage();

		console.log("En snapshotFile");
		var foto_temp = $('#my_camera').data('urltemp');

		// display results in page
		document.getElementById('foto').innerHTML = 
			// '<h2>Here is your image:</h2>' + 
			'<img src="'+foto_temp+'"/>' +
			'<div class="esquinas-camara" id="esquinasfotof"></div>';
			// '<div class="esquinas-camara" id="esquinasfotof"><div class="encuadre" id="encuadrefotof"></div></div>';
			// '<input id="btnsave" type=button value="screenSHot" onClick="screenshot()">';

	// alert("transmitir");
	// transmitirPosicionamiento("#foto img",-1);

	// if(Utils.isIDevice)
	// {	
	// 	// alert("transmitir mobile");
	// 	// DoRotate(0);

	// 	transmitirPosicionamiento("#foto img",0);

	// 	// transmitirPosicionamiento("#foto img");

	// }		
					
}




function take_snapshot(e) {
	// take snapshot and get image data

	console.log("En snapshot");

	e.preventDefault();

	$('#btn-continuar-snapshot').on('click',mostrarEleccionPersonajes);

	if (Webcam.loaded)
	{	
		$('#btn-snapshot').hide();
		$('#btn-repetir-snapshot').show();

		$('#btn-continuar-snapshot').bind('click', false);

		$('#btn-continuar-snapshot').animate({opacity: 1});
		$('#btn-subir-snapshot').animate({opacity: 1});		
	}



	Webcam.snap( function(data_uri) {
		// display results in page


		document.getElementById('my_camera').innerHTML = 
			'<img src="'+data_uri+'"/>' +
			'<div class="esquinas-camara" id="esquinascamara"></div>';

		document.getElementById('foto').innerHTML = 
			 '<img src="'+data_uri+'"/>' + 
			'<div class="esquinas-camara" id="esquinasfoto2"></div>';		
	} );
}



// function upload_snapshot() {
// 	Webcam.upload( src64_imagen,'myscript.php', salida());	
// }

// function salida()
// {
// 	console.log("adios la luz");
// }




function screenshot() {

	console.log("Haciendo pantallazo");

	// $( "#foto .esquinas-camara" ).remove();

    html2canvas($("#foto"), {
        onrendered: function(canvas) {
            var theCanvas = canvas;
            document.getElementById('foto-fin').appendChild(canvas);

//             theCanvas.toBlob(function(blob) {
			// 	saveAs(blob, "Dashboard.png"); 
			// });
    		oContexto = canvas.getContext('2d');
			oURL = canvas.toDataURL();

			// console.log("oURL: "+oURL);

			$('.elige-personaje').hide();
			$('.elige-frase').show();	
        }
    });


	// if(Utils.isIDevice)
	// {	
	// 	// alert("transmitir mobile");
	// 	// DoRotate(0);

	// 	transmitirPosicionamiento("#foto-fin canvas",90);

	// 	DoRotateFin(-90);		

	// 	// transmitirPosicionamiento("#foto img");

	// }			

}

function UploadFoto () 
{
	console.log("Haciendo Upload");

    html2canvas($("#foto-fin"), {
        onrendered: function(canvas2) {
            var theCanvas = canvas2;
            // document.getElementById('foto-fin').appendChild(canvas2);


		    vData = canvas2.toDataURL();
		    // console.log("vData: "+vData);

			//document.getElementById('foto-fin').append ='<div id="img_recortada" style="width:500px; height:500px; position:relative; left:73px;"></div>';

			$('<div/>', {
		        'id': 'img_recortada',
		        'style': 'width:500px; height:500px; position:relative; left:73px;',
		        'html':'<img class="cropimage" src="'+vData+'" cropwidth="300" cropheight="356"/>'
		    }).appendTo('#foto-fin',1);

			// oURL2 = canvas2.toDataURL();

			cropear();
			setTimeout(uploadAjax, 1000);

			$('.contenedor-flechas').hide();

            }
    });
	
}

var hrefFacebookurl ="http://www.facebook.com/sharer.php?s=100&p[url]=www.mortadelizate.es";

var hrefFacebookResto = "&p[images][0]=www.mortadelizate.es/images/share_rs.jpg&p[title]=Mortadelízate&p[summary]=Si tu también quieres mortadelizar tu careto y que consiga cien millones de likes entra aquí http://wwww.mortadelizate.es/. ¡No lo dudes y #mortadelizate!#MyF3D 28 de noviembre en cines.";

function uploadAjax () 
{
		// console.log("vDataFinal Despues: "+ vDataFinal);
		// alert("Alert vDataFinal : "+ vDataFinal);

		$.ajax({
	      type: "POST",
	      url: "upload.php",
	      data: {image: vDataFinal}
	    }).done(function( respond ) {
	      console.log(respond);
	      // alert(respond);


		var urlFotoDownload = urlHost+respond;
		var folderDownload =respond.split('/')[0];

		// console.log(respond);
		console.log(urlFotoDownload);

		$('#btn-download').attr('href',urlFotoDownload);
		$('#btn-download').attr('download',"mortadelizado.png");


		/*Montando la url compartuda en fb y twitter*/

		var hrefCompartir = "http://www.facebook.com/sharer.php?s=100&p[url]=http://"+urlHostName+"/" + respond;
		var hrefTwitter = "http://twitter.com/intent/tweet?text=%23Mortadelizate%20y%20deja%20tu%20careto%20igual%20de%20flipante%20que%20el%20mío. http://"+urlHostName+"/" + respond + " Entra%20en%20http%3A%2F%2F"+urlHostName+"%2F%20%23MyF3D";

		$('#enviar-facebook').attr('href',hrefCompartir);
		$('#enviar-twitter').attr('href',hrefTwitter);

		console.log("hrefCompartir: " +hrefCompartir+"hrefTwitter: " +hrefTwitter);





	    });
}


function cargarClasesObjetosBig () 
{
	
	console.log("Cargando clases Objetos Big");

	// $('.foto').removeClass('big1 big2 big3 big4 big5 big6');
	if(Utils.browser.searchMobile() && tam_ventana< 480 )
	{
		console.log("Cargando clases Objetos Small");
		$('.foto').removeClass('big1 big2 big3 big4 big5 big6');
		$('.foto').addClass('small'+cont_personajes);
		tamañoPersonaje = 'Sma';
	}
	else	
	{
		console.log("Cargando clases Objetos Big");
		$('.foto').removeClass('small1 small2 small3 small4 small5 small6');
		$('.foto').addClass('big'+cont_personajes);
		tamañoPersonaje = 'Big';
	}

}


function colocarObjeto1 (e) 
{
	e.preventDefault();
	cargarClasesObjetosBig();

	idObjPersonaje = 'obj'+cont_personajes+tamañoPersonaje+'1';

	// var position = $('#big1 #'+idObjPersonaje).position();
	// var left = position.left;

	// left += 30;

	// console.log("left: "+left);

	// $('#foto #'+idObjPersonaje).css('left', left+'px');

	// console.log("Colocando objeto 1: "+objPers1);


	if(objetoUno==0)
	{
		console.log("pon: "+objetoUno);

		var i=1;
		for(;i<=1;i++){
		    $('<div/>', {
		        'id': idObjPersonaje,
		        'html':'<img src="'+objPers1+'"/>'
		    }).appendTo('#foto',1);
		}
		// $('#foto #'+idObjPersonaje).css({top: '111px', left: '181px', zIndex: '1'},100);
		$('#listado-objetos #objeto1').fadeTo( "slow" , 0.3);

		objetoUno = cont_personajes;
		idObjPersonaje_anteriorUno = idObjPersonaje;
	}

	else if(objetoUno==cont_personajes)
	{
		//quita
		console.log("quita: "+objetoUno);

		$('#foto #'+idObjPersonaje).remove();
		$('#listado-objetos #objeto1').fadeTo( "slow" , 1);
		
		objetoUno = 0;
	}
			
	else
	{
		//quita y pon

		console.log("quita y pon: "+objetoUno);

		$('#foto #'+idObjPersonaje_anteriorUno).remove();
		$('#listado-objetos #objeto1').fadeTo( "slow" , 1);

		var i=1;
		for(;i<=1;i++){
		    $('<div/>', {
		        'id': idObjPersonaje,
		        'html':'<img src="'+objPers1+'"/>'
		    }).appendTo('#foto',1);
		}
		// $('#foto #'+idObjPersonaje).css({top: '111px', left: '181px', zIndex: '1'},100);
		$('#listado-objetos #objeto1').fadeTo( "slow" , 0.3);		

		objetoUno = cont_personajes;
		idObjPersonaje_anteriorUno = idObjPersonaje;
	}
}


function colocarObjeto2 (e) 
{
	e.preventDefault();
	cargarClasesObjetosBig();

	idObjPersonaje = 'obj'+cont_personajes+tamañoPersonaje+'2';

	
	console.log("Colocando objeto 2: "+objPers2);


	if(objetoDos==0)
	{
		console.log("pon: "+objetoDos);

		var i=1;
		for(;i<=1;i++){
		    $('<div/>', {
		        'id': idObjPersonaje,
		        'html':'<img src="'+objPers2+'"/>'
		    }).appendTo('#foto',1);
		}
		// $('#foto #'+idObjPersonaje).css({top: '111px', left: '181px', zIndex: '1'},100);
		$('#listado-objetos #objeto2').fadeTo( "slow" , 0.3);

		objetoDos = cont_personajes;
		idObjPersonaje_anteriorDos = idObjPersonaje;
	}

	else if(objetoDos==cont_personajes)
	{
		//quita
		console.log("quita: "+objetoDos);

		$('#foto #'+idObjPersonaje).remove();
		$('#listado-objetos #objeto2').fadeTo( "slow" , 1);
		
		objetoDos = 0;
	}
			
	else
	{
		//quita y pon

		console.log("quita y pon: "+objetoDos);

		$('#foto #'+idObjPersonaje_anteriorDos).remove();
		$('#listado-objetos #objeto2').fadeTo( "slow" , 1);

		var i=1;
		for(;i<=1;i++){
		    $('<div/>', {
		        'id': idObjPersonaje,
		        'html':'<img src="'+objPers2+'"/>'
		    }).appendTo('#foto',1);
		}
		// $('#foto #'+idObjPersonaje).css({top: '111px', left: '181px', zIndex: '1'},100);
		$('#listado-objetos #objeto2').fadeTo( "slow" , 0.3);		

		objetoDos = cont_personajes;
		idObjPersonaje_anteriorDos = idObjPersonaje;
	}
}


function colocarObjeto3 (e) 
{
	e.preventDefault();
	cargarClasesObjetosBig();

	idObjPersonaje = 'obj'+cont_personajes+tamañoPersonaje+'3';

	
	console.log("Colocando objeto 3: "+objPers3);


	if(objetoTres==0)
	{
		console.log("pon: "+objetoTres);

		var i=1;
		for(;i<=1;i++){
		    $('<div/>', {
		        'id': idObjPersonaje,
		        'html':'<img src="'+objPers3+'"/>'
		    }).appendTo('#foto',1);
		}
		// $('#foto #'+idObjPersonaje).css({top: '111px', left: '181px', zIndex: '1'},100);
		$('#listado-objetos #objeto3').fadeTo( "slow" , 0.3);

		objetoTres = cont_personajes;
		idObjPersonaje_anteriorTres = idObjPersonaje;
	}

	else if(objetoTres==cont_personajes)
	{
		//quita
		console.log("quita: "+objetoTres);

		$('#foto #'+idObjPersonaje).remove();
		$('#listado-objetos #objeto3').fadeTo( "slow" , 1);
		
		objetoTres = 0;
	}
			
	else
	{
		//quita y pon

		console.log("quita y pon: "+objetoTres);

		$('#foto #'+idObjPersonaje_anteriorTres).remove();
		$('#listado-objetos #objeto3').fadeTo( "slow" , 1);

		var i=1;
		for(;i<=1;i++){
		    $('<div/>', {
		        'id': idObjPersonaje,
		        'html':'<img src="'+objPers3+'"/>'
		    }).appendTo('#foto',1);
		}
		// $('#foto #'+idObjPersonaje).css({top: '111px', left: '181px', zIndex: '1'},100);
		$('#listado-objetos #objeto3').fadeTo( "slow" , 0.3);		

		objetoTres = cont_personajes;
		idObjPersonaje_anteriorTres = idObjPersonaje;
	}
}


/*Envio de mail*/

function mostrarFormularioMail (e) 
{
	
	$('#confirmar-enviar').hide().delay(300);
	$('#form-mail').show();

	e.preventDefault();


}


$("#btn-enviar").click(function() 
    {
 		
 		console.log("en boton_enviomail");

 		foto = $('#btn-download').attr('href');

	    var emaildes = $(".emaildes").val();
	    var	nombre = $(".nombre").val();
        var emailrem = $(".emailrem").val();
	    var validacion_email = /^[a-zA-Z0-9_\.\-]+@[a-zA-Z0-9\-]+\.[a-zA-Z0-9\-\.]+$/;

	        // console.log("nombre: "+nombre + "emailrem: "+emailrem + "emaildes: "+emaildes + "foto: "+foto);
	 
	        if (nombre == "") {
            $(".nombre").focus();
            return false;
        }else if(emailrem == "" || !validacion_email.test(emailrem)){
            $(".emailrem").focus();    
            return false;
        }else if(emaildes == "" || !validacion_email.test(emaildes)){
            $(".emaildes").focus();    
            return false;
	        }else{
	            $('.ajaxgif').removeClass('hide');
	            var datosmail = 'foto=' + foto + '&emaildes=' + emaildes  + '&nombre=' + nombre  + '&emailrem=' + emailrem;
	            $.ajax({
	                type: "POST",
	                url: "envio-mail/compartir-mail.php",
	                data: datosmail,
	                success: function() {
	                    $('.ajaxgif').hide();
	                    $('.msg').show();
	                    $('.msg').text('Enviado').addClass('msg_ok');
	                    console.log("Enviado por ajax");
	                   	/*Reseteamos los campos del formulario de envio de la receta cuando se cambia de receta*/
			            //setTimeout(resetearCamposMail, 3000); 
	                },
	                error: function() {
	                    $('.ajaxgif').hide();
	                    $('.msg').show();
	                    $('.msg').text('Error').addClass('msg_error');                 
	                }
	            });

	            return false;
	        }
	 
    });

function DoRotate(d) {

    $("#foto img").css({
          '-moz-transform':'rotate('+d+'deg)',
          '-webkit-transform':'rotate('+d+'deg)',
          '-o-transform':'rotate('+d+'deg)',
          '-ms-transform':'rotate('+d+'deg)',
          'transform': 'rotate('+d+'deg)'
     });  
}

function DoRotateFin(d) {

    $("#foto-fin canvas").css({
          '-moz-transform':'rotate('+d+'deg)',
          '-webkit-transform':'rotate('+d+'deg)',
          '-o-transform':'rotate('+d+'deg)',
          '-ms-transform':'rotate('+d+'deg)',
          'transform': 'rotate('+d+'deg)'
     });  
}

function cropear () {

  $( '.cropimage' ).each( function () {
    var image = $(this),
        cropwidth = image.attr('cropwidth'),
        cropheight = image.attr('cropheight');

      image.cropbox( {width: cropwidth, height: cropheight, showControls: 'no' } )
        .on('cropbox', function( event, results, img ) {
          document.getElementById('img_recortada').innerHTML = 
          '<img src="' + img.getDataURL() + '"/>';

          vDataFinal = img.getDataURL();

          // console.log("vDataFinal: "+vDataFinal);

        }); 
	});

 
}


function RedirectSmartphone(url)
{
    if ( (url && url.length > 0 && Utils.browser.searchMobile() ) || tam_ventana< 768)
    {
         console.log("redireccion");
         window.location = url;
         $('.blanco').show();
    }
    else
    {
		console.log("nada");
		$('.blanco').hide();
    }    
        
}


